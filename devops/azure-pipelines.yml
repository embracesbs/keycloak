trigger:
- release-embrace

resources:
  repositories:
  - repository: MyGitHubKeycloakContainers
    type: github
    endpoint: GitHubEmbraceSBSKeycloak
    name: embracesbs/keycloak-containers
    ref: refs/tags/10.0.2

variables:
- name: Version.Tag
  value: 10.0.2
- name: Version.Revision
  value: $[counter(variables['Version.Tag'], 0)]
- name: Version
  value: $(Version.Tag)$(Version.Revision)
- name: Docker.ServiceConnectionName
  value: 'dockerembrace'
- name: Docker.Registry
  value: 'dockerembrace.azurecr.io' 
- name: Docker.Repository.Name
  value: keycloak-embrace

pool:
  vmImage: 'ubuntu-latest'

steps:

- checkout: MyGitHubKeycloakContainers
  path: buildscripts

- task: Docker@2
  name: DockerBuild
  displayName: 'Docker Build'
  inputs:
    command: build
    containerRegistry: $(Docker.ServiceConnectionName)
    repository: $(Docker.Repository.Name)
    dockerfile: '$(Agent.BuildDirectory)/buildscripts/server/Dockerfile'
    arguments: --build-arg GIT_REPO=embracesbs/keycloak --build-arg GIT_BRANCH=release-embrace
    addPipelineData: false
    tags: |
      $(Version)

- task: Docker@2
  name: DockerPush
  condition: and(succeeded(), not(eq(variables['Build.Reason'], 'PullRequest'))) # don't run for pullrequest (pr's only do build as a CI process)
  displayName: 'Docker Push'
  inputs:
    command: push
    containerRegistry: $(Docker.ServiceConnectionName)
    repository: $(Docker.Repository.Name)
    buildContext: '**'
    addPipelineData: false
    tags: |
      $(Version)
